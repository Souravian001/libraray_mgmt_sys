<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Library Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
        
        /* Navbar */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 8px 15px; cursor: pointer; }

        /* Grid Layout for the Flowchart Boxes */
        .container { display: flex; gap: 20px; margin-top: 20px; }
        .section { 
            flex: 1; 
            background: white; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* Section Colors to match logic */
        .admin-section { border-top: 5px solid #d9534f; } /* Red for Admin */
        .report-section { border-top: 5px solid #5bc0de; } /* Blue for Reports */
        .trans-section { border-top: 5px solid #5cb85c; } /* Green for Transactions */

        h3 { margin-top: 0; }
        button { display: block; width: 100%; margin-top: 10px; padding: 10px; cursor: pointer; }

        /* The Class that hides elements */
        .hidden { display: none !important; }
        
        /* Result Area */
        #display-area { margin-top: 20px; padding: 15px; background: #fff; border: 1px dashed #999; min-height: 100px; }
    </style>
</head>
<body onload="initDashboard()">

    <div class="header">
        <h2 id="welcome-msg">Welcome</h2>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        
        <div id="maintenance-menu" class="section admin-section hidden">
    <h3>Maintenance Menu</h3>
    <p><i>Admin Access Only</i></p>

    <div style="background: #fff5f5; padding: 10px; border: 1px dashed red; margin-bottom: 10px;">
        <strong>Add New Book:</strong>
        <input type="text" id="bookTitle" placeholder="Title (e.g. Physics)" style="margin-top:5px;">
        <input type="text" id="bookCategory" placeholder="Category (e.g. Science)" style="margin-top:5px;">
        <input type="number" id="bookStock" placeholder="Stock (e.g. 5)" style="margin-top:5px;">
        
        <button onclick="addBook()" style="background: #d9534f; color: white; margin-top:5px;">Save Book</button>
    </div>

    <button onclick="alert('Membership feature coming soon')">Add Membership</button>
    <button onclick="alert('User feature coming soon')">Add User</button>
</div>

        <div class="section report-section">
            <h3>Reports Menu</h3>
            <button onclick="getBooks()">Master List of Books</button>
            <button>Active Issues</button>
            <button>Overdue Returns</button>
        </div>

        <div class="section trans-section">
    <h3>Transactions</h3>
    
    <button onclick="toggleForm('issue-form')">Issue a Book</button>
    <div id="issue-form" class="hidden" style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
        <input type="number" id="issueBookId" placeholder="Book ID">
        <input type="text" id="issueMember" placeholder="Member Name">
        <label>Due Date:</label>
        <input type="date" id="issueDate">
        <button onclick="issueBook()" style="background: green; color: white;">Confirm Issue</button>
    </div>

    <button onclick="toggleForm('return-form')">Return a Book</button>
    <div id="return-form" class="hidden" style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
        <input type="number" id="returnBookId" placeholder="Book ID">
        <input type="text" id="returnMember" placeholder="Member Name">
        <button onclick="returnBook()" style="background: orange; color: black;">Confirm Return</button>
    </div>

    <button>Check Availability</button>
    </div>
    </div>

    <div id="display-area">
        <p style="color: #777;">Select an option above to see data here...</p>
    </div>
<script>
        // 1. Run this when page loads
        function initDashboard() {
            const role = localStorage.getItem('userRole');
            const user = localStorage.getItem('username');

            if (!role) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('welcome-msg').innerText = `Welcome, ${user} (${role})`;

            // SHOW ADMIN MENU IF ADMIN
            if (role === 'admin') {
                document.getElementById('maintenance-menu').classList.remove('hidden');
            }
        }

        // 2. Fetch Books (Reports)
        async function getBooks() {
            try {
                const response = await fetch('http://localhost:3000/books');
                const books = await response.json();
                
                const display = document.getElementById('display-area');
                
                let html = '<h4>Book Catalog</h4><table border="1" cellpadding="5" style="width:100%; border-collapse:collapse;">';
                html += '<tr><th>ID</th><th>Title</th><th>Category</th><th>Stock</th></tr>'; // Added Stock column
                
                books.forEach(book => {
                    html += `<tr>
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${book.category}</td>
                        <td>${book.available_stock}</td> 
                    </tr>`;
                });
                html += '</table>';
                display.innerHTML = html;

            } catch (err) {
                console.error(err);
                alert("Error fetching books");
            }
        }

        // 3. Logout
        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // 4. Toggle Forms (Helper)
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            form.classList.toggle('hidden');
        }

        // ------------------------------------------
        // MISSING FUNCTION 1: ADD BOOK
        // ------------------------------------------
        async function addBook() {
            const title = document.getElementById('bookTitle').value;
            const category = document.getElementById('bookCategory').value;
            const stock = document.getElementById('bookStock').value;

            if(!title || !stock) return alert("Please enter Title and Stock");

            try {
                const response = await fetch('http://localhost:3000/add-book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, category, stock })
                });

                const data = await response.json();
                if (data.success) {
                    alert("Book Added Successfully!");
                    getBooks(); // Refresh list
                    // Clear inputs
                    document.getElementById('bookTitle').value = '';
                    document.getElementById('bookStock').value = '';
                } else {
                    alert("Error: " + JSON.stringify(data));
                }
            } catch (err) {
                console.error(err);
                alert("Server Connection Error");
            }
        }

        // ------------------------------------------
        // MISSING FUNCTION 2: ISSUE BOOK
        // ------------------------------------------
        async function issueBook() {
            const bookId = document.getElementById('issueBookId').value;
            const memberName = document.getElementById('issueMember').value;
            const dueDate = document.getElementById('issueDate').value;

            if (!bookId || !memberName || !dueDate) {
                return alert("Please fill in all fields (ID, Name, Date)");
            }

            try {
                const response = await fetch('http://localhost:3000/issue-book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookId, memberName, dueDate })
                });

                const data = await response.json();

                if (data.success) {
                    alert("Book Issued Successfully!");
                    toggleForm('issue-form'); // Close form
                    getBooks(); // Refresh stock
                } else {
                    alert("Error: " + data.message);
                }
            } catch(err) {
                console.error(err);
                alert("Server Error");
            }
        }

        // ------------------------------------------
        // EXISTING FUNCTION: RETURN BOOK
        // ------------------------------------------
        async function returnBook() {
            const bookId = document.getElementById('returnBookId').value;
            const memberName = document.getElementById('returnMember').value;

            if (!bookId || !memberName) return alert("Please enter Book ID and Member Name");

            try {
                const response = await fetch('http://localhost:3000/return-book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookId, memberName })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.fineAmount > 0) {
                        alert(`OVERDUE WARNING!\nFine Amount: $${data.fineAmount}`);
                    } else {
                        alert(" Book returned successfully. No fine.");
                    }
                    getBooks(); // Refresh stock
                    document.getElementById('returnBookId').value = '';
                } else {
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("Server Error");
            }
        }
    </script>
    
</body>

</html>
